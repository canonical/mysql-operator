# Copyright 2022 Canonical Ltd.
# See LICENSE file for licensing details.
name: Tests

on:
  pull_request:
  push:
    branches:
      - main
  workflow_call:

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install tox
        # TODO: Consider replacing with custom image on self-hosted runner OR pinning version
        run: python3 -m pip install tox
      - name: Run linters
        run: tox run -e lint

  unit-test:
    name: Unit tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install tox
        # TODO: Consider replacing with custom image on self-hosted runner OR pinning version
        run: python3 -m pip install tox
      - name: Run tests
        run: tox run -e unit

  get-build-matrix:
    name: Create build matrix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Install tox
        # TODO: Consider replacing with custom image on self-hosted runner OR pinning version
        run: python3 -m pip install tox
      - name: Create build matrix from charmcraft.yaml file(s)
        id: create-matrix
        run: tox run -e create-build-matrix
    outputs:
      build-matrix: ${{ steps.create-matrix.outputs.build_matrix }}

  build:
    strategy:
      matrix:
        charm: ${{ fromJSON(needs.get-build-matrix.outputs.build-matrix) }}
    name: Build ${{ matrix.charm.name }} charm / ${{ matrix.charm.series }}
    needs:
      - get-build-matrix
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup environment
        # TODO: Replace with custom image on self-hosted runner
        run: |
          # Copied from https://github.com/charmed-kubernetes/actions-operator/blob/96fb0b07eb675f74cf1796be812bc7e67a0d62fc/src/bootstrap/index.ts#L151
          sudo adduser $USER lxd
          newgrp lxd
          sudo lxd waitready
          sudo lxd init --auto
          sudo iptables -F FORWARD
          sudo iptables -P FORWARD ACCEPT
          sudo chmod a+wr /var/snap/lxd/common/lxd/unix.socket
          sudo snap install charmcraft --classic
      - name: Get charmcraft version
        id: charmcraft-version
        # Major and minor versions (e.g. "2.1")
        run: echo "version=$(charmcraft version | cut --delimiter '.' --fields 1,2)" >> $GITHUB_OUTPUT
      - name: Cache `charmcraft pack` LXC instance(s)
        uses: actions/cache@v3
        with:
          path: ~/ga-charmcraft-cache/**
          key: charmcraft-pack-${{ matrix.charm.path }}-${{ matrix.charm.bases_index }}-${{ steps.charmcraft-version.outputs.version }}-${{ hashFiles(format('{0}/charmcraft.yaml', matrix.charm.path)) }}-${{ github.sha }}
          restore-keys: charmcraft-pack-${{ matrix.charm.path }}-${{ matrix.charm.bases_index }}-${{ steps.charmcraft-version.outputs.version }}-${{ hashFiles(format('{0}/charmcraft.yaml', matrix.charm.path)) }}-
      - name: Import cached container(s)
        run: |
          if [ ! -d ~/ga-charmcraft-cache/ ]
          then
            echo No cached containers to import
            exit 0
          fi
          # Project setup copied from https://github.com/canonical/craft-providers/blob/20d154bb8fa9868a678c5621f124a02e2b9e72ad/craft_providers/lxd/project.py#L26
          lxc project create charmcraft
          lxc --project default profile show default | lxc --project charmcraft profile edit default
          charm_repository_directory_inode=$(stat --format "%i" ${{ matrix.charm.path }})
          for container_tarball in ~/ga-charmcraft-cache/*
          do
            lxc --project charmcraft import $container_tarball
            container_name_without_inode=$(basename --suffix .tar $container_tarball)
            # Replace placeholder text "INODE" with inode
            container_name_with_inode=$(echo $container_name_without_inode | sed "s/INODE/$charm_repository_directory_inode/")
            lxc --project charmcraft move $container_name_without_inode $container_name_with_inode
          done
      - name: Pack charm
        working-directory: ${{ matrix.charm.path }}
        run: charmcraft pack --bases-index=${{ matrix.charm.bases_index }}
      - run: touch .empty
      - name: Upload packed charm(s)
        uses: actions/upload-artifact@v3
        with:
          name: packed-charms
          # .empty file required to preserve directory structure
          # See https://github.com/actions/upload-artifact/issues/344#issuecomment-1379232156
          path: |
            ${{ matrix.charm.path }}/*.charm
            .empty
          if-no-files-found: error
      - name: Export `charmcraft pack` container(s) to cache
        run: |
          mkdir -p ~/ga-charmcraft-cache
          charm_repository_directory_inode=$(stat --format "%i" ${{ matrix.charm.path }})
          for container_name_with_inode in $(lxc --project charmcraft list --columns n --format csv)
          do
            # Replace inode with placeholder text "INODE"
            container_name_without_inode=$(echo $container_name_with_inode | sed "s/$charm_repository_directory_inode/INODE/")
            lxc --project charmcraft move $container_name_with_inode $container_name_without_inode
            # Use GitHub actions/cache compression
            lxc --project charmcraft export --optimized-storage --compression none $container_name_without_inode ~/ga-charmcraft-cache/$container_name_without_inode.tar
          done
      - name: Prune cache from previous runs
        # GitHub actions cache is limited to 10 GiB per repository
        # https://docs.github.com/en/actions/using-workflows/caching-dependencies-to-speed-up-workflows#usage-limits-and-eviction-policy
        shell: python
        run: |
          import json
          import logging
          import subprocess
          import sys


          def run_gh_cli(*args, json_response=True):
              """Run command with GitHub CLI"""
              output = subprocess.check_output(
                  ["gh", "api", "-H", "Accept: application/vnd.github+json", *args]
              )
              if json_response:
                  return json.loads(output)
              return output


          def delete_cache(cache_: dict) -> None:
              logging.info(f"Deleting cache id {cache_['id']} on {cache_['ref']} with key {cache_['key']}")
              run_gh_cli(
                  "--method",
                  "DELETE",
                  "/repos/{owner}/{repo}/actions/caches/" + str(cache_["id"]),
                  json_response=False,
              )
              global bytes_used
              bytes_used -= cache["size_in_bytes"]


          logging.basicConfig(level=logging.INFO, stream=sys.stdout)
          caches = run_gh_cli(
              "--method",
              "GET",
              "/repos/{owner}/{repo}/actions/caches",
              "--raw-field",
              "key=charmcraft-pack-${{ matrix.charm.path }}-${{ matrix.charm.bases_index }}-",
              "--raw-field",
              "sort=created_at",
              "--raw-field",
              "direction=desc",  # Most recently created first
          )["actions_caches"]
          if not caches:
              logging.info("No caches")
              exit()
          # Updated about every 5 minutes
          # https://docs.github.com/en/rest/actions/cache?apiVersion=2022-11-28#get-github-actions-cache-usage-for-a-repository
          bytes_used = run_gh_cli("--method", "GET", "/repos/{owner}/{repo}/actions/cache/usage")[
              "active_caches_size_in_bytes"
          ]
          fresh_caches = {}  # Last created cache for a ref (branch or PR)
          for cache in caches:
              if (ref := cache["ref"]) not in fresh_caches:
                  fresh_caches[ref] = cache
              else:
                  # Cache is stale (no longer in use); delete it
                  delete_cache(cache)

          CURRENT_REF = "${{ github.ref }}"
          expected_cache_size = (fresh_caches.get(CURRENT_REF) or list(fresh_caches.values())[0])[
              "size_in_bytes"
          ]
          # Move current ref cache to end of fresh_caches insertion order
          if current_ref_cache := fresh_caches.pop(CURRENT_REF, None):
              fresh_caches[CURRENT_REF] = current_ref_cache
          fresh_caches = list(fresh_caches.items())
          bytes_required = int(expected_cache_size * 1.2)  # Add 20% margin
          GIBIBYTE = 1073741824  # 1 GiB
          while (bytes_available := 10 * GIBIBYTE - bytes_used) < bytes_required:
              logging.info(
                  f"{bytes_available/GIBIBYTE:.1f} GiB available, {bytes_required/GIBIBYTE:.1f} GiB required"
              )
              # Delete current ref cache if it exists or delete the oldest cache
              ref, cache = fresh_caches.pop(-1)
              if ref == "refs/heads/main":
                  continue
              delete_cache(cache)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  integration-test:
    strategy:
      fail-fast: false
      matrix:
        tox-environments:
          - integration-ha
          - integration-db-router
          - integration-shared-db
          - integration-database
          - integration-mysql-interface
          # TODO: re-enable when stable (currently flaky)
          # - integration-healing
          - integration-tls
        series:
          - focal
          - jammy
    name: ${{ matrix.tox-environments }} / ${{ matrix.series }}
    needs:
      - lint
      - unit-test
      - build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Setup operator environment
        # TODO: Replace with custom image on self-hosted runner
        uses: charmed-kubernetes/actions-operator@main
        with:
          provider: lxd
          bootstrap-options: "--agent-version 2.9.29"
      - name: Download packed charm(s)
        uses: actions/download-artifact@v3
        with:
          name: packed-charms
      - name: Run integration tests
        run: tox run -e ${{ matrix.tox-environments }} -- --series=${{ matrix.series }}
